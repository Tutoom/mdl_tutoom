{"version":3,"file":"activity.min.js","sources":["../src/activity.js"],"sourcesContent":["/* eslint-disable */\nimport Templates from \"core/templates\";\nimport { exception as displayException } from \"core/notification\";\n\nM.mod_tutoom = M.mod_tutoom || {};\n\nexport const init = (ID, isModerator, baseUrl) => {\n  const spinnerHTML =\n    \"<div class='spinner-border spinner-border-sm text-dark'></div>\";\n\n  const ACTIONS = {\n    GET_MEETING: \"get_meeting\",\n    START_MEETING: \"start_meeting\",\n    JOIN_MEETING: \"join_meeting\",\n    END_MEETING: \"end_meeting\",\n    GET_RECORDINGS: \"get_recordings\",\n  };\n\n  const getMeeting = async () => {\n    const url = `${baseUrl}?action=${ACTIONS.GET_MEETING}&sesskey=${M.cfg.sesskey}&id=${ID}`;\n    return await window.fetch(url);\n  };\n\n  const renderTemplate = ({ data }) => {\n    const element = document.getElementById(\"tutoom-main-section\");\n\n    Templates.renderForPromise(\"mod_tutoom/main_section\", data)\n      .then(({ html, js }) => {\n        Templates.replaceNodeContents(element, html, js);\n      })\n      .catch((error) => displayException(error));\n  };\n\n  document.addEventListener(\"click\", (e) => {\n    const elementId = e.target.id;\n    if (!elementId) return;\n\n    if (elementId === \"tutoom-start-button\") startMeeting(e);\n    if (elementId === \"tutoom-end-button\") endMeeting(e);\n    if (elementId === \"tutoom-join-button\") joinMeeting(e);\n    if (elementId === \"tutoom-refresh-main-section\") clearMainSection(e);\n  });\n\n  const startMeeting = async (e) => {\n    e.preventDefault();\n\n    const el = document.getElementById(\"tutoom-start-button\");\n    const widthButton = el.offsetWidth;\n    const lastHTML = el.innerHTML;\n\n    el.style.width = `${widthButton}px`;\n    el.innerHTML = spinnerHTML;\n\n    try {\n      const url = `${baseUrl}?action=${ACTIONS.START_MEETING}&sesskey=${M.cfg.sesskey}&id=${ID}&logoutUrl=${window.location.href}`;\n      const fetch = await window.fetch(url);\n      const response = await fetch.json();\n\n      const { error, id } = response;\n\n      if (error) {\n        const data = { error: true, errorcode: error.errorCode };\n        renderTemplate({ data });\n      }\n\n      if (id) {\n        const res = await getMeeting();\n        const { creationTimestamp, participantsCount } = await res.json();\n\n        let meetingDate = new Date(creationTimestamp._seconds * 1000);\n        meetingDate = meetingDate.toLocaleTimeString(navigator.language, {\n          hour: \"2-digit\",\n          minute: \"2-digit\",\n        });\n\n        const data = {\n          meetingid: id,\n          ismoderator: isModerator,\n          meetingdate: meetingDate,\n          participantscount: `${participantsCount}`,\n          istextpluralparticipant: participantsCount > 1,\n        };\n\n        renderTemplate({ data });\n      }\n    } catch (error) {\n      console.error(error);\n      el.innerHTML = lastHTML;\n    }\n  };\n\n  const joinMeeting = async (e) => {\n    e.preventDefault();\n\n    const el = document.getElementById(\"tutoom-join-button\");\n    const widthButton = el.offsetWidth;\n    const lastHTML = el.innerHTML;\n\n    el.style.width = `${widthButton}px`;\n    el.innerHTML = spinnerHTML;\n\n    try {\n      const url = `${baseUrl}?action=${ACTIONS.JOIN_MEETING}&sesskey=${M.cfg.sesskey}&id=${ID}`;\n      const fetch = await window.fetch(url);\n      const { joinurl } = await fetch.json();\n\n      if (!joinurl || joinurl === null) {\n        const data = { error: true, meetingidnotexists: true };\n        renderTemplate({ data });\n      } else {\n        window.location.href = joinurl;\n      }\n    } catch (error) {\n      console.error(error);\n    } finally {\n      el.innerHTML = lastHTML;\n    }\n  };\n\n  const endMeeting = async (e) => {\n    e.preventDefault();\n\n    const value = e.target.value;\n\n    const el = document.getElementById(\"tutoom-end-button\");\n    const widthButton = el.offsetWidth;\n    const lastHTML = el.innerHTML;\n\n    el.style.width = `${widthButton}px`;\n    el.innerHTML = `<div class='spinner-border spinner-border-sm text-danger'></div>`;\n\n    try {\n      const url = `${baseUrl}?action=${ACTIONS.END_MEETING}&sesskey=${M.cfg.sesskey}&id=${ID}&meetingId=${value}`;\n      const fetch = await window.fetch(url);\n      const response = await fetch.json();\n\n      const { error, deleted } = response;\n\n      if (error) {\n        console.error(error);\n\n        if (error.meetingidnotexists) {\n          const data = { error: true, meetingidnotexists: true };\n          renderTemplate({ data });\n        }\n      }\n\n      if (deleted) clearMainSection(e);\n    } catch (error) {\n      console.error(error);\n    } finally {\n      el.innerHTML = lastHTML;\n    }\n  };\n\n  const clearMainSection = (e) => {\n    e.preventDefault();\n\n    const data = { meetingid: null, ismoderator: isModerator };\n    renderTemplate({ data });\n  };\n};\n"],"names":["M","mod_tutoom","ID","isModerator","baseUrl","spinnerHTML","ACTIONS","getMeeting","url","cfg","sesskey","window","fetch","renderTemplate","data","element","document","getElementById","renderForPromise","then","html","js","replaceNodeContents","catch","error","addEventListener","e","elementId","target","id","startMeeting","endMeeting","joinMeeting","clearMainSection","preventDefault","el","widthButton","offsetWidth","lastHTML","innerHTML","style","width","location","href","json","response","errorcode","errorCode","res","creationTimestamp","participantsCount","meetingDate","Date","_seconds","toLocaleTimeString","navigator","language","hour","minute","meetingid","ismoderator","meetingdate","participantscount","istextpluralparticipant","console","joinurl","meetingidnotexists","value","deleted"],"mappings":"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"}